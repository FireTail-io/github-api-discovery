name: Publish Release
run-name: '@${{ github.triggering_actor }}: ${{ github.ref_name }}: ${{ github.event_name }}: ${{ github.event.action }}'
on:
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: firetail-code-repository-scanner

jobs:
  publish-release:
    name: Publish Release
    environment: prod
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write

    steps:

      - name: Set Image Tags
        run: |
          echo "TAG_BASE=${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}" >>${GITHUB_ENV}

      - name: Log In to the Container Registry
        run: |
           docker login ${{ env.REGISTRY }} \
            --username ${{ github.actor }} \
            --password-stdin <<<${{ secrets.GITHUB_TOKEN }}

      - name: Publish Prelease Lambda Image as Full Release
        run: |
          docker pull ${{ env.TAG_BASE }}:${{ github.ref_name }}-prerelease
          docker tag ${{ env.TAG_BASE }}:${{ github.ref_name }}-prerelease \
            ${{ env.TAG_BASE }}:${{ github.ref_name }}
          docker tag ${{ env.TAG_BASE }}:${{ github.ref_name }}-prerelease \
            ${{ env.TAG_BASE }}:latest
          docker push ${{ env.TAG_BASE }}:${{ github.ref_name }}
          docker push ${{ env.TAG_BASE }}:latest

      - name: Publish Prelease Lambda Image as Full Release
        run: |
          docker pull ${{ env.TAG_BASE }}:${{ github.ref_name }}-lambda-prerelease
          docker tag ${{ env.TAG_BASE }}:${{ github.ref_name }}-lambda-prerelease \
            ${{ env.TAG_BASE }}:${{ github.ref_name }}-lambda
          docker tag ${{ env.TAG_BASE }}:${{ github.ref_name }}-lambda-prerelease \
            ${{ env.TAG_BASE }}:latest-lambda
          docker push ${{ env.TAG_BASE }}:${{ github.ref_name }}-lambda
          docker push ${{ env.TAG_BASE }}:latest-lambda

      - name: Summarize Workflow Run
        run: |
          cat <<HEREDOC >>${GITHUB_STEP_SUMMARY}
          ## Successfully Pushed:

          - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}-lambda
          - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest-lambda
          HEREDOC
